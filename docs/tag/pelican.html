<!DOCTYPE html>
<html lang="english">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>My Blog - pelican</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">My Blog</a></h1>
                <nav><ul>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/ad-group-authentication-asp-net-core-app.html">Authenticate Users By AD Group In An ASP.NET Core App</a></h1>
<footer class="post-info">
        <abbr class="published" title="2021-12-01T14:07:00+01:00">
                Published: Wed 01 December 2021
        </abbr>
		<br />
        <abbr class="modified" title="2021-12-02T10:49:00+01:00">
                Updated: Thu 02 December 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/craig-saboe.html">Craig Saboe</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/pelican.html">pelican</a> <a href="/tag/publishing.html">publishing</a> </p>
</footer><!-- /.post-info --><p>To restrict access to an ASP.NET Core application via Active Directory group membership:</p>
<ul>
<li>Set authentication in IIS for the given site so that only "Windows Authentication" is enabled.</li>
<li>Modify your Startup.cs to add authentication and an authorization policy requiring a role (i.e. AD group membership)</li>
<li>Add the [Authorize] attribute to any controller to be locked down.</li>
</ul>
<p>ex: Startup.cs</p>
<div class="highlight"><pre><span></span><code><span class="n">using</span> <span class="n">System</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Linq</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Tasks</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Authorization</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Builder</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Hosting</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Mvc</span><span class="o">.</span><span class="n">Authorization</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Server</span><span class="o">.</span><span class="n">IISIntegration</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">Extensions</span><span class="o">.</span><span class="n">Configuration</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">Extensions</span><span class="o">.</span><span class="n">DependencyInjection</span><span class="p">;</span>
<span class="n">using</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">Extensions</span><span class="o">.</span><span class="n">Hosting</span><span class="p">;</span>

<span class="n">namespace</span> <span class="n">Boilerplate</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="k">class</span> <span class="n">Startup</span>
    <span class="p">{</span>
        <span class="n">public</span> <span class="n">Startup</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Configuration</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">IConfiguration</span> <span class="n">Configuration</span> <span class="p">{</span> <span class="n">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="n">gets</span> <span class="n">called</span> <span class="n">by</span> <span class="n">the</span> <span class="n">runtime</span><span class="o">.</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">method</span> <span class="n">to</span> <span class="n">add</span> <span class="n">services</span> <span class="n">to</span> <span class="n">the</span> <span class="n">container</span><span class="o">.</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">services</span><span class="o">.</span><span class="n">AddAuthentication</span><span class="p">(</span><span class="n">IISDefaults</span><span class="o">.</span><span class="n">AuthenticationScheme</span><span class="p">);</span>
            <span class="n">services</span><span class="o">.</span><span class="n">AddAuthorization</span><span class="p">(</span><span class="n">options</span> <span class="o">=&gt;</span>
            <span class="p">{</span>
                <span class="n">options</span><span class="o">.</span><span class="n">AddPolicy</span><span class="p">(</span><span class="s2">&quot;ADRoleOnly&quot;</span><span class="p">,</span> <span class="n">policy</span> <span class="o">=&gt;</span> <span class="n">policy</span><span class="o">.</span><span class="n">RequireRole</span><span class="p">(</span><span class="s2">&quot;MYDOMAIN</span><span class="se">\\</span><span class="s2">SOMEADGROUP&quot;</span><span class="p">));</span>
            <span class="p">});</span>
            <span class="o">...</span>
            <span class="n">services</span><span class="o">.</span><span class="n">AddMvc</span><span class="p">(</span><span class="n">config</span> <span class="o">=&gt;</span>
            <span class="p">{</span>
                <span class="k">var</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AuthorizationPolicyBuilder</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">RequireAuthenticatedUser</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">Build</span><span class="p">();</span>

                <span class="n">config</span><span class="o">.</span><span class="n">Filters</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span> <span class="n">AuthorizeFilter</span><span class="p">(</span><span class="n">policy</span><span class="p">));</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="n">gets</span> <span class="n">called</span> <span class="n">by</span> <span class="n">the</span> <span class="n">runtime</span><span class="o">.</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">method</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">the</span> <span class="n">HTTP</span> <span class="n">request</span> <span class="n">pipeline</span><span class="o">.</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IWebHostEnvironment</span> <span class="n">env</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">IsDevelopment</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="o">.</span><span class="n">UseDeveloperExceptionPage</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="o">.</span><span class="n">UseExceptionHandler</span><span class="p">(</span><span class="s2">&quot;/Home/Error&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">app</span><span class="o">.</span><span class="n">UseStaticFiles</span><span class="p">();</span>

            <span class="n">app</span><span class="o">.</span><span class="n">UseRouting</span><span class="p">();</span>

            <span class="n">app</span><span class="o">.</span><span class="n">UseAuthorization</span><span class="p">();</span>

            <span class="n">app</span><span class="o">.</span><span class="n">UseStatusCodePages</span><span class="p">(</span><span class="n">async</span> <span class="n">context</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">StatusCode</span> <span class="o">==</span> <span class="mi">403</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="o">//</span> <span class="n">your</span> <span class="n">redirect</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">Redirect</span><span class="p">(</span><span class="s2">&quot;/Home/Error&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>

            <span class="n">app</span><span class="o">.</span><span class="n">UseEndpoints</span><span class="p">(</span><span class="n">endpoints</span> <span class="o">=&gt;</span>
            <span class="p">{</span>
                <span class="n">endpoints</span><span class="o">.</span><span class="n">MapControllerRoute</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
                    <span class="n">pattern</span><span class="p">:</span> <span class="s2">&quot;{controller=Home}/{action=Index}/{id?}&quot;</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong> Apply to given controllers... </strong></p>
<div class="highlight"><pre><span></span><code>namespace Boilerplate.Controllers
{
    [Authorize(Policy = &quot;ADRoleOnly&quot;)]
    public class HomeController : Controller
....
</code></pre></div>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>